<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="guest">
	
	<select id="myguest" resultType="com.example.syFinal.guest.model.dto.GuestDTO">
		select 
		g_idx,
		g_email,
		g_name,
		g_photo,
		g_phone,
		g_url,
		g_profile,
		g_level,
		g_card,
		g_date,
		g_cvc,
		g_point
		from guest
		where g_idx=#{g_idx}
	</select>
	
	<select id="paylist" resultType="com.example.syFinal.guest.model.dto.GuestDTO">
		SELECT 
		g_idx,
		d_img1, 
		o_state, 
		o_orderdate, 
		o_payment, 
		o_ckin, 
		o_ckout, 
		o_finalprice
		FROM hotel_detail d, orders o, guest g
		WHERE d.d_idx = o.o_didx AND g.g_idx = o_gidx 
		and g_idx=#{g_idx}
		order BY o_orderdate
	</select>
	
	<update id="cardupdate">
		update guest 
		set g_card = #{g_card}, g_date = #{g_date}, g_cvc=#{g_cvc}
		where g_idx = #{g_idx}
	</update>
	
	<update id="carddelete">
		update guest 
		set g_card = null, g_date = null, g_cvc= null
		where g_idx = #{g_idx}
	</update>
	
	<!-- 예약시 호텔정보 -->
	<select id="hotelinfo" resultType="com.example.syFinal.host.model.dto.HotelDTO">
		SELECT d_idx,ho_img,ho_name,d_price
		FROM hotel h, hotel_detail d
		WHERE h.ho_idx = d.d_ho_idx
		AND d_idx = #{d_idx}
	</select>
	
	<!-- 예약요청 -->
	<insert id="order">
		INSERT INTO orders 
		(o_gidx,o_didx,o_ckin,o_ckout,o_adult,o_child,o_baby,o_payment,o_price,o_finalprice,o_orderdate)
		VALUES 
		(#{idx},#{didx},#{ckin},#{ckout},#{adult},#{child},#{baby},#{pay},#{dprice},#{fprice},now())
	</insert>
	
	<select id="reviewlist" resultType="com.example.syFinal.guest.model.dto.ReviewDTO">
		SELECT 
		g_idx, 
		h_idx,
		d_idx,
		ho_idx,
		ho_name,
		d_img1,
		h_profile, 
		h_name, 
		DATE_FORMAT(rv_date, '%Y년 %m월 %d일') as rv_date,
		rv_content
		FROM guest g, host h, review rv, hotel_detail hd, hotel ho
		WHERE g.g_email = rv.rv_writer AND rv.rv_hd_idx = hd.d_idx AND hd.d_ho_idx = ho.ho_idx AND ho.ho_h_idx = h.h_idx
		AND g_idx=#{gidx}
	</select>
	
	<select id="replylist" resultType="com.example.syFinal.guest.model.dto.ReviewDTO">
		SELECT 
		g_idx, 
		h_idx, 
		h_profile, 
		h_name, 
		DATE_FORMAT(rp_date, '%Y년 %m월 %d일') as rp_date,
		rp_content
		FROM guest g, host h, reply rp, review rv, hotel_detail hd, hotel ho
		WHERE g.g_email = rv.rv_writer AND rp.rp_rv_idx = rv.rv_idx AND rv.rv_hd_idx = hd.d_idx AND hd.d_ho_idx = ho.ho_idx AND ho.ho_h_idx = h.h_idx
		AND g_idx=#{gidx}
	</select>
	
	<select id="reviewcount" resultType="com.example.syFinal.guest.model.dto.ReviewDTO">
		SELECT COUNT(*) as reviewcount
		FROM review
		WHERE rv_writer=(SELECT g_email from guest where g_idx=#{gidx})
	</select>
	
	<select id="joindate" resultType="com.example.syFinal.guest.model.dto.GuestDTO">
		SELECT (TO_DAYS(now()) - TO_DAYS(g_join_date)) AS joindate
		FROM guest
		WHERE g_idx=#{gidx}
	</select>
</mapper>